SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  This workload is a mixed workload to test the maximum throughput that
  can be achieved by change event application (CEA). The workload starts Mongosync
  on a cluster with an empty initial dataset, waits for it to transition to
  CEA and then starts inserting documents on the source cluster.

Keywords:
- c2c
- replication
- cluster to cluster sync
- change event application
- CEA

EnvironmentDetails:
  MongosyncConnectionURIs:
  - http://localhost:27182

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500

ScriptsPath: &scriptsPath ./MongosyncScripts.yml

GlobalDefaults:
  Database: &Database db
  Collection: &Collection Collection0

Actors:

- Name: HelloWorld
  Type: HelloWorld
  Phases:
    - &nop {Nop: true}
    - *nop
    - *nop
    - *nop
    - *nop
    - *nop
    - *nop
    - Message: generate CEA load
      Duration: 2 minutes
    - *nop
    - *nop
    - *nop
    - *nop

- Name: SetupSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - LoadConfig:
      Path: *scriptsPath
      Key: SetupShardKey
  - LoadConfig:
      Path: *scriptsPath
      Key: ShardCollectionAndSplit
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop

- Name: Mongosync
  Type: Python
  Threads: 1
  Phases:
  - *nop
  - *nop
  - LoadConfig:
      Path: *scriptsPath
      Key: StartMongosync
  - LoadConfig:
      Path: *scriptsPath
      Key: PollForCEA
  - LoadConfig:
      Path: *scriptsPath
      Key: PauseMongosync
  - *nop
  - LoadConfig:
      Path: *scriptsPath
      Key: ResumeMongosync
  - LoadConfig:
      Path: *scriptsPath
      Key: DrainWrites
  - LoadConfig:
      Path: *scriptsPath
      Key: Commit
  - LoadConfig:
      Path: *scriptsPath
      Key: WaitForCommit
  - LoadConfig:
      Path: *scriptsPath
      Key: Verify
  - LoadConfig:
      Path: *scriptsPath
      Key: WaitForVerifyDone

- Name: InsertDocs
  Type: Loader
  Threads: 1
  Phases:
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - LoadConfig:
      Path: *scriptsPath
      Key: InsertLargeDoc
  - *nop
  - LoadConfig:
      Path: *scriptsPath
      Key: InsertCEADoc
  - *nop
  - *nop
  - *nop
  - *nop


- Name: InsertInitDocs
  Type: RunCommand
  Threads: 1
  Phases:
  - *nop
  - Repeat: 1
    Database: db
    Collection: Collection0
    CollectionCount: 1
    Threads: 1
    Operations:
    - OperationName: InsertInitDoc
      OperationCommand:
        WriteOperations:
        - WriteCommand: insertOne
          Document: { _id: 0 }
        - WriteCommand: insertOne
          Document: { _id: 1000 }
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop

- Name: InsertRandDocs
  Type: Loader
  Threads: 1
  Phases:
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - LoadConfig:
      Path: *scriptsPath
      Key: InsertRandDoc
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop
  - *nop


  # Note that currently there is no autorun section in this workload as it is
  # being invoked manually
